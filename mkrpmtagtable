#!/usr/bin/perl

use Getopt::Long;
use Mysql;

use Env qw(LSBUSER LSBDBPASSWD LSBDB LSBDBHOST);

sub usage()
{
print STDERR "mkrpmtag -g <groupname> -t <tabletitle> -v <lsbversion>\n";
die;
}

# Uncomment to trace SQL statments
#$trace=1;

#
# 1) process the arguments
#
GetOptions("g=s" => \$groupname,
			"v=s" => \$lsbversion,
			"t=s" => \$title);

if( !$groupname ) { usage(); }
if( !$title ) { usage(); }
if( !$lsbversion ) { usage(); }

#
# 2) Establish connection to the database
#
$Dbh = Mysql->connect($LSBDBHOST,$LSBDB,$LSBUSER, $LSBDBPASSWD) || die $Mysql::db_errstr;

#
# 3) get the data
#
$select = "SELECT * FROM RpmTag ";
$select.= "WHERE Rgroup=".$Dbh->quote($groupname);
$select.= " AND (Rappearedin IS NOT NULL and Rappearedin <= '$lsbversion' and Rappearedin<>'') ";
$select.= " AND (Rwithdrawnin IS NULL OR Rwithdrawnin > '$lsbversion') ";
$select.= " ORDER BY Rtag ";
print STDERR $select,"\n" if $trace;
$sth = $Dbh->query($select) || die $select."\n".$Dbh->errmsg();

printf("<!-- Start of text generated from database -->\n");
printf("<!-- generated from the LSB specification database -->\n");
printf("<!--    by \$Header: mkrpmtagtable 1.2 2005-05-11 21:46:31 nick Exp $- -->\n");
my $now_string = localtime;
printf("<!--    at %s -->\n", $now_string );

if($sth->numrows) {
	print "<TABLE>\n";
	print "<TITLE>$title</TITLE>\n";
	print "<TGROUP COLS=5>\n";
	print "<THEAD>\n";
	print "<ROW>\n";
	print "<ENTRY ALIGN=center>Name</ENTRY>";
	print "<ENTRY ALIGN=center>Tag Value</ENTRY>";
	print "<ENTRY ALIGN=center>Type</ENTRY>";
	print "<ENTRY ALIGN=center>Count</ENTRY>";
	print "<ENTRY ALIGN=center>Status</ENTRY>";
	print "</ROW>\n";
	print "</THEAD>\n";
	print "<TBODY>\n";
	for(1..$sth->numrows) {
		print "<ROW>";
		%entry=$sth->fetchhash;
		printf "<ENTRY><CONSTANT>%s</CONSTANT></ENTRY>",$entry{'Rname'};
		printf "<ENTRY>%s</ENTRY>",$entry{'Rtag'};
		printf "<ENTRY>%s</ENTRY>",$entry{'Rtype'};
		if( $entry{'Rcount'} ) {
			printf "<ENTRY>%s</ENTRY>",$entry{'Rcount'};
		} else {
			printf "<ENTRY></ENTRY>";
		}
		printf "<ENTRY>%s</ENTRY>",$entry{'Rstatus'};
		print "</ROW>\n";
	}
	print "</TBODY>\n";
	print "</TGROUP>\n";
	print "</TABLE>\n";
}

$select = "SELECT * FROM RpmTag ";
$select.= "WHERE Rgroup=".$Dbh->quote($groupname);
$select.= " AND (Rappearedin IS NOT NULL and Rappearedin <= '$lsbversion' and Rappearedin<>'') ";
$select.= " AND (Rwithdrawnin IS NULL OR Rwithdrawnin > '$lsbversion') ";
$select.= " ORDER BY Rtag ";
#print $select,"\n";
$sth = $Dbh->query($select) || die $Dbh->errmsg();

if($sth->numrows) {
	print "<VARIABLELIST>\n";
	for(1..$sth->numrows) {
		print "<VARLISTENTRY>";
		%entry=$sth->fetchhash;
		printf "<TERM><CONSTANT>%s</CONSTANT></TERM>",$entry{'Rname'};
		printf "<LISTITEM><PARA>%s</PARA></LISTITEM>",$entry{'Rdescription'};
		print "</VARLISTENTRY>\n";
	}
print "</VARIABLELIST>\n";
}

printf("<!-- End of text generated from database -->\n");
printf("<!--    by \$Header: mkrpmtagtable 1.2 2005-05-11 21:46:31 nick Exp $- -->\n");

