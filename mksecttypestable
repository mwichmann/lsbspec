#!/usr/bin/perl

use Getopt::Long;
use Mysql;

use Env qw(LSBUSER LSBDBPASSWD LSBDB LSBDBHOST);

sub usage()
{
print STDERR "mksecttypestable -a <archname> -s <stdname> -t <tabletitle>\n";
die;
}

# Uncomment to trace SQL statments
#$trace=1;

#
# 1) process the arguments
#
GetOptions("a=s" => \$archname,
           "s=s" => \$stdname,
           "t=s" => \$title);

if( !$archname ) { usage(); }
if( !$stdname ) { usage(); }
if( !$title ) { usage(); }

#
# 2) Establish connection to the database
#
$Dbh = Mysql->connect($LSBDBHOST,$LSBDB,$LSBUSER, $LSBDBPASSWD) || die $Mysql::db_errstr;

#
# 3) get & print the architecture info
#
$select = "SELECT * FROM Architecture WHERE ";
$select.= "Architecture.Aname=".$Dbh->quote($archname);
print STDERR $select,"\n" if $trace;
$sth = $Dbh->query($select) || die $select."\n".$Dbh->errmsg();

%entry=$sth->fetchhash;
$Aid=$entry{'Aid'};
$Aname=$entry{'Aname'};

if( not $Aname ) {
	die "Unsupported architecture";
}

$select = "SELECT * ";
$select.= "FROM SectionTypes,Standard ";
$select.= "WHERE STstandard=Sid and Sname=".$Dbh->quote($stdname);
$select.= " AND STarch=$Aid";
$select.= " ORDER BY SectionTypes.STname ";
#print $select,"\n";
$sth = $Dbh->query($select) || die $Dbh->errmsg();

printf("<!-- Start of text generated from database -->\n");
printf("<!-- generated from the LSB specification database -->\n");
printf("<!--    by \$Header: mksecttypestable 1.10 2005-05-18 15:28:19 anderson Exp $- -->\n");
my $now_string = localtime;
printf("<!--    at %s -->\n", $now_string );

#
# Tables need IDs so we can XREF them ...
# 
local $tbl_id;
$tbl_id = "tbl.$stdname";

printf "<TABLE ID=%s>\n", $tbl_id;
print "<TITLE>$title</TITLE>\n";
print "<TGROUP COLS=3>\n";
print "<THEAD>\n";
print "<ROW>\n";
print "<ENTRY ALIGN=center>Name</ENTRY>";
print "<ENTRY ALIGN=center>Value</ENTRY>";
print "<ENTRY ALIGN=center>Description</ENTRY>";
print "</ROW>\n";
print "</THEAD>\n";
print "<TBODY>\n";
for(1..$sth->numrows) {
	print "<ROW>";
	%entry=$sth->fetchhash;
	$stname = $entry{'STname'};
	$stname =~s/\_//g;
	printf "<ENTRY ID=\"Secttype.%s\" XREFLABEL=\"%s\">%s</ENTRY>",
	$stname, $entry{'STname'}, $entry{'STname'};
	printf "<ENTRY>0x%x</ENTRY>",$entry{'STvalue'};
	printf "<ENTRY>%s</ENTRY>",$entry{'STdescription'};
	print "</ROW>\n";
}
print "</TBODY>\n";
print "</TGROUP>\n";
print "</TABLE>\n";

printf("<!-- End of text generated from database -->\n");
printf("<!--    by \$Header: mksecttypestable 1.10 2005-05-18 15:28:19 anderson Exp $- -->\n");
