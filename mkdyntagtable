#!/usr/bin/perl

use Getopt::Long;
use Mysql;

use Env qw(LSBUSER LSBDBPASSWD LSBDB LSBDBHOST);

sub usage()
{
print STDERR "mkdyntagtable -a <archname> -s <stdname> [-c <numcols>] [-d]\n";
die;
}

# Uncomment to trace SQL statments
#$trace=1;

#
# 1) process the arguments
#
$numcols=1;
$dodesc=0;
GetOptions("a=s" => \$archname,
	   "s=s" => \$stdname,
	   "c=i" => \$numcols,
	   "d" => \$dodesc);

if( !$archname ) { usage(); }
if( !$stdname ) { usage(); }

#
# 2) Establish connection to the database
#
$Dbh = Mysql->connect($LSBDBHOST,$LSBDB,$LSBUSER, $LSBDBPASSWD) || die $Mysql::db_errstr;

#
# 3) get & print the architecture info
#
$select = "SELECT * FROM Architecture WHERE ";
$select.= "Architecture.Aname=".$Dbh->quote($archname);
print STDERR $select,"\n" if $trace;
$sth = $Dbh->query($select) || die $select."\n".$Dbh->errmsg();

%entry=$sth->fetchhash;
$Aid=$entry{'Aid'};
$Aname=$entry{'Aname'};

$select = "SELECT DEname,DEdescription ";
$select.= "FROM DynamicEntries,Standard ";
$select.= "WHERE DEstandard=Sid and Sname=".$Dbh->quote($stdname)." ";
$select.= "AND DEarch=$Aid ";
$select.= "AND DEstatus='Included' ";
$select.= "ORDER BY DynamicEntries.DEname ";
#print $select,"\n";
$sth = $Dbh->query($select) || die $Dbh->errmsg();

printf("<!-- Start of text generated from database -->\n");
printf("<!-- generated from the LSB specification database -->\n");
printf("<!--    by \$Header: /home/mats.deb/cvsrepo/lsb/lsbspec.smaller/mkdyntagtable,v 1.5 2002-05-30 23:07:44 anderson Exp $- -->\n");
my $now_string = localtime;
printf("<!--    at %s -->\n", $now_string );

if($sth->numrows) {
	print "<VARIABLELIST>\n";
	for(1..$sth->numrows) {
		print "<VARLISTENTRY>";
		%entry=$sth->fetchhash;
		printf "<TERM>%s</TERM>",$entry{'DEname'};
		printf "<LISTITEM><PARA>%s</PARA></LISTITEM>",$entry{'DEdescription'};
		print "</VARLISTENTRY>";
	}
print "</VARIABLELIST>\n";
}
printf("<!-- End of text generated from database -->\n");
printf("<!--    by \$Header: /home/mats.deb/cvsrepo/lsb/lsbspec.smaller/mkdyntagtable,v 1.5 2002-05-30 23:07:44 anderson Exp $- -->\n");
